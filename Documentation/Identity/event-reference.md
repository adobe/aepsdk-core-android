# Identity event reference

## Events handled

The following events are handled by the Identity extension:

### Identity request identity

#### Event description

This event is used for the Identity extension to complete one of the following tasks::

- To retrieve the custom visitor identifiers
- To retrieve the ECID (MID)
- To append the visitor identifiers to an URL
- To synchronize a visitor identifier or a list of identifiers with the ECID service

This event is generated by:

- Calling the Identity `getIdentifiers` API
- Calling the Identity `getExperienceCloudId` API
- Calling the Identity `appendVisitorInfoForURL` (Android) / `appendToUrl` (iOS) API
- Calling the Identity `getUrlVariables` API
- Calling the Identity `syncIdentifier` or `syncIdentifiers` APIs

#### Event details

| **Event type**                 | **Event source**                        | **Paired** | **Paired event**                                                |
| :----------------------------- | :-------------------------------------- | :--------- | :-------------------------------------------------------------- |
| `com.adobe.eventType.identity` | `com.adobe.eventSource.requestIdentity` | Yes        | [Identity Response Identity event](#identity-response-identity) |

#### Data payload definition

The following key-value pairs are used in this event:

| **Key**               | **Value type** | **Required** | **Description**                                                                                                                                                    |
| :-------------------- | :------------- | :----------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `baseurl`             | String         | No           | The base URL passed as parameter to the `appendVisitorInfoForURL` (Android) / `appendToUrl` (iOS) API.                                                             |
| `urlvariables`        | Boolean        | No           | This key is present in the Identity request event when the `getUrlVariables` API is called.                                                                        |
| `visitoridentifiers`  | Map            | No           | The visitor identifiers that need to be synced with the ECID service. The keys of the map are the identifier types and the values are the associated identifiers.  |
| `authenticationstate` | Integer        | No           | The Visitor ID authentication state. The different numbers represent different values: <ul><li>0: Unknown</li><li>1: Authenticated</li><li>2: Logged out</li></ul> |

#### Event data example

**Append to URL request**

```javascript
{
    "baseurl": "https://example.com/path?query=parameter1&other=parameter2"
}
```

**Get URL variables request**

```javascript
{
    "urlvariables": true
}
```

**Sync identifiers request**

```javascript
{
    "visitoridentifiers": {
        "idtype1" : "id1",
        "idtype2" : "id2"
    },
    "authenticationstate" : 1
}
```

### Generic request identity

#### Event description

This event is used to set identifiers in the Identity extension and it is generated by:

- Calling the MobileCore (Android) / ACPCore (iOS) `setAdvertisingIdentifier` API
- Calling the MobileCore (Android) / ACPCore (iOS) `setPushIdentifier` API

#### Event details

| **Event type**                         | **Event source**                        | **Paired** | **Paired event** |
| :------------------------------------- | :-------------------------------------- | :--------- | :--------------- |
| `com.adobe.eventType.generic.identity` | `com.adobe.eventSource.requestIdentity` | No         | N/A              |

#### Data payload definition

The following key-value pairs are used in this event:

| **Key**                 | **Value type** | **Required** | **Description**                                                                                                                                                         |
| :---------------------- | :------------- | :----------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `advertisingidentifier` | String         | No           | The value of the Advertising Identifier for the mobile device that needs to be set in the SDK. This key is populated when the `setAdvertisingIdentifier` API is called. |
| `pushidentifier`        | String         | No           | The value of the Push Identifier that needs to be set. This key is populated when the `setPushIdentifier` API is called.                                                |

#### Event data example

**Set the Advertising Identifier request**

```javascript
{
    "advertisingidentifier": "advertisingIdExample"
}
```

**Set the Push Identifier request**

```javascript
{
    "pushidentifier": "pushIdExample"
}
```

### Analytics Identity response

Identity Extension listens to Analytics Identity Response Event to retrieve the value of the Analytics tracking identifier (AID) that is returned as part of the visitor information for the appendToURL and getUrlVariables API calls.

<!-- For more details see the documentation on the [Analytics response identity](../../adobe-analytics/event-reference.md#analytics-response-identity). -->

### Audience Manager content response

The Identity extension listens for the Audience Manager extension response content event for any user opt-out updates. If this response contains `optedouthitsent: false`, an opt-out network call is sent to the Experience Cloud Identity Service.

<!-- For more details see the documentation on the [Audience Manager content response](../../adobe-audience-manager/event-reference.md#audience-manager-content-response). -->

### Configuration response content

#### Event description

Whenever the configuration extension dispatches the Configuration Response Content event, the Identity extension fetches the URL of the Experience Cloud Identity Service, Experience Cloud Organization Identifier, and the Privacy status settings.

This event is generated in the following scenarios:

- Initial configuration requested by the customer
- Configuration modified, either by remote update or a local developer action
- In response to a configuration request event with the `config.getData` data key

For more information about the data payload definition for this event, please read the **Configuration Keys** section in the various extensions' documentation.

#### Event details

| **Event type**                    | **Event source**                      | **Paired** | **Paired event** |
| :-------------------------------- | :------------------------------------ | :--------- | :--------------- |
| com.adobe.eventType.configuration | com.adobe.eventSource.responseContent | No         | N/A              |

The data property in the Configuration response content event is used by each extension to modify its current settings. Each extension is responsible to read out the part of the data property for which it is concerned.

#### Data payload definition

The Identity extension reads the following keys from the configuration event:

The following key-value pairs are used in this event:

| **Key**                  | **Value type** | **Required** | **Description**                                                    |
| :----------------------- | :------------- | :----------- | :----------------------------------------------------------------- |
| `experienceCloud.org`    | String         | No           | The Experience Cloud Org identifier                                |
| `experienceCloud.server` | Sting          | No           | Custom endpoint to be used for Visitor ID Service network requests |
| `global.privacy`         | String         | No           | Contains the mobile privacy status settings                        |

### Event Hub shared state

#### Event description

The shared state event is dispatched by the event hub after a shared state is created or updated. The event data contains the event owner, the name of the extension to which the shared state belongs. The Identity extension triggers processing the queued events, if any, when the configuration's shared state is updated.

#### Event details

| **Event type**          | **Event source**                  | **Paired** | **Paired event** |
| :---------------------- | :-------------------------------- | :--------- | :--------------- |
| com.adobe.eventType.hub | com.adobe.eventSource.sharedState | No         | N/A              |

#### Data payload definition

Definition of the key/value pairs that are present in this event

| **Key**    | **Value type** | **Required** | **Description** |
| :--------- | :------------- | :----------- | :-------------- |
| stateOwner | String         | N/A          | N/A             |

## Events dispatched

The following events are dispatched by the Identity extension:

### Identity response identity

This event is a response from the Identity extension to the public API callbacks, and it will be generated in response to an Identity Request dentity event when:

- Retrieving the ECID (MID).
- Retrieving the custom visitor identifiers.
- Synchronizing a visitor identifier or a list of identifiers with the ECID Service is complete.
- The result for the append to URL request is ready.

#### Event details

| **Event type**               | **Event source**                       | **Paired** | **Paired event**                                              |
| :--------------------------- | :------------------------------------- | :--------- | :------------------------------------------------------------ |
| com.adobe.eventType.identity | com.adobe.eventSource.responseIdentity | Yes        | [Identity Request Identity event](#identity-request-identity) |

#### Data payload definition

The following key-value pairs are used in this event:

| **Key**                 | **Value type** | **Required** | **Description**                                                                                                                                                                                                        |
| :---------------------- | :------------- | :----------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `mid`                   | String         | No           | The value of the Experience Cloud Identifier (MID).                                                                                                                                                                    |
| `advertisingidentifier` | String         | No           | The value of the Advertising Identifier if it was previously set.                                                                                                                                                      |
| `pushidentifier`        | String         | No           | The Push Identifier if one was previously set.                                                                                                                                                                         |
| `blob`                  | String         | No           | The blob value retrieved from the ECID Service.                                                                                                                                                                        |
| `locationhint`          | String         | No           | The location hint value retrieved from the ECID Service.                                                                                                                                                               |
| `visitoridslist`        | `List`         | No           | A list of visitor identifiers that were previously synced using `syncIdentifier` or `syncIdentifiers` public APIs. Each visitor ID will have the following keys: `id_origin`, `id_type`, `id`, `authentication_state`. |
| `lastsync`              | Long           | No           | Timestamp in seconds of the last sync call sent to the ECID Service, by default it is 0.                                                                                                                               |
| `updatedurl`            | String         | No           | The update URL when `appendVisitorInfoForURL` (Android) / `appendToUrl` (iOS) public API is called.                                                                                                                    |
| `urlvariables`          | String         | No           | The Visitor IDs as query parameters string when `getUrlVariables` API is called.                                                                                                                                       |

#### Event data examples

**All identifiers, blob, and location hint are populated**

```javascript
{
    "mid": "midExample",
    "advertisingidentifier": "advertisingIdExample",
    "pushidentifier": "pushIdExample",
    "blob": "blobExample",
    "locationhint": "locationHintExample",
    "visitoridslist": [{
        "id_type": "type1",
        "id_origin": "origin1",
        "id": "id1",
        "authentication_state": 1
    },
    {
        "id_type": "type2",
        "id_origin": "origin2",
        "id": "id2",
        "authentication_state": 2
    }]
}
```

**`appendToUrl` response**

```javascript
{
    "updatedurl": "https://example.com/path?query=parameter1&other=parameter2&adobe_mc=TS%3D1563845864296%7CMCMID%3Dmidexample%7CMCORGID%3Dorgidexample%40AdobeOrg%7CMCAID%3Daidexample&adobe_aa_vid=videxample"
}
```

**`getUrlVariables` response**

```javascript
{
    "urlvariables": "adobe_mc=TS%3D1563845864296%7CMCMID%3Dmidexample%7CMCORGID%3Dorgidexample%40AdobeOrg%7CMCAID%3Daidexample&adobe_aa_vid=videxample"
}
```

<InlineAlert variant="warning" slots="text"/>

The Analytics Custom VID is no longer included in the Identity event data payload. If you need it, you can retrieve it by using the `getVisitorIdentifier` API in the [Adobe Analytics extension](https://github.com/adobe/aepsdk-analytics-android/blob/main/Documentation/api-reference.md#getvisitoridentifier).

### Configuration content request

The Identity extension dispatches a new Configuration Content Request event when a privacy change is detected in the response that is received from the ECID Service. This event is handled by the Core extension, and the new privacy status is broadcasted to other extensions.

<!-- For more details about this event, please read the [Mobile Core Configuration event reference](../configuration/event-reference.md). -->

### Analytics content request

The Identity extension dispatches a new Analytics Content Request event when a push status preference change is detected, when the push identifier is initially set, or when it is cleared from the SDK. This event is handled by the Analytics extension, and a new internal hit is sent to the Adobe Analytics Server.

<!-- For more details about this event, please read the Analytics Content Request section of the [Adobe Analytics event reference](../../adobe-analytics/event-reference.md#analytics-content-request) -->

## Shared state

**EXTENSION_NAME**: `com.adobe.module.identity`

The Identity extension shared state is created in the following situations:

- When the extension first loads and is initialized.
- When handling a sync request, regardless of whether an actual sync occurs. Occurs when setting the Push Identifier, the Advertising Identifier, or the customer's custom identifiers.
- When the global privacy status changes to `optedout`, a shared state is set after the identifiers are cleared.

| Key                     | Type     | Description                                                                                                                                             |
| :---------------------- | :------- | :------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `mid`                   | String   | MID is a unique ID for that visitor for the given Experience Cloud organization ID.                                                                     |
| `advertisingidentifier` | String   | On iOS, this value is the IDFA that is retrieved from Apple APIs. On Android, the Advertising Identifier that is returned from Google Play Services.    |
| `pushidentifier`        | String   | The Push Identifier.                                                                                                                                    |
| `blob`                  | String   | The blob value returned by the the ECID Service.                                                                                                        |
| `locationhint`          | String   | The ECID Service region ID. A region ID (or location hint), is a numeric identifier for the geographic location of a particular ID service data center. |
| `visitoridslist`        | `<List>` | The list of all the customer's custom identifiers.                                                                                                      |
| `lastsync`              | Long     | The timestamp of the last sync with the ECID Service (in seconds). The default value 0.                                                                 |
